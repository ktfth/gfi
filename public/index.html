<html>
  <body>
    <input type="file">
    <pre id="log"></pre>
    <script src="simple-peer-wrapper.min.js"></script>
    <script>
      const options = {
        serverUrl: 'https://gfi-com.herokuapp.com',
      };

      const spw = new SimplePeerWrapper(options);

      const files = [];
      let connectionState = true;

      setInterval(() => {
        if (connectionState) {
          window.location.href = '/';
        }
      }, 2000);

      spw.connect();

      spw.on('connect', () => {
        console.log('connected');
        const log = document.querySelector('#log');
        files.forEach((d) => {
          spw.send(d.data);
        });
        log.textContent = 'Connected!';
        connectionState = false;
      });

      spw.on('data', (data) => {
        const a = document.createElement('a');
        a.innerHTML = `Download (${data.data.filename})`;
        document.body.appendChild(a);
        if (!files.some((d) => d.userId === data.userId)) {
          files.push(data);
        }
        const blob = new Blob([data.data.result], {type: 'octet/stream'});
        const url = window.URL.createObjectURL(blob);
        a.href = url;
        a.download = `${data.data.filename}`;
      });

      function prepareFile(filename) {
        return (e) => {
          spw.send({
            result: e.target.result,
            filename,
          });
        };
      }

      const input = document.querySelector('input[type=file]');

      function changeFile() {
        const file = input.files[0];
        const reader = new FileReader();
        reader.addEventListener('load', prepareFile(file.name));
        reader.readAsText(file);
      }

      input
        .addEventListener('change', changeFile);

      window.onbeforeunload = () => {
        spw.close();
      };
    </script>
  </body>
</html>
